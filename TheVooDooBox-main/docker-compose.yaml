services:
  hyper-bridge:
    build: ./backend
    ports:
      - "8080:8080"
      - "9001:9001"
    environment:
      - PROXMOX_URL=https://192.168.50.200:8006
      - PROXMOX_USER=root@pam
      - PROXMOX_TOKEN_ID=MalwareLab
      - PROXMOX_TOKEN_SECRET=${PROXMOX_TOKEN_SECRET}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - OLLAMA_URL=http://192.168.50.98:11434
      - OLLAMA_MODEL=llama-server
      - EMBEDDING_URL=http://192.168.50.98:11435
      - EMBEDDING_MODEL=nomic-embed-text
      - CHROMADB_URL=http://192.168.50.98:8001
      - DATABASE_URL=postgres://voodoobox:${POSTGRES_PASSWORD}@db:5432/voodoobox_telemetry
      - RUST_LOG=debug
      - HOST_IP=${HOST_IP}
      - REMNUX_MCP_URL=http://192.168.50.199:8090/sse
      - REMNUX_MCP_TOKEN=voodoo-secret-token
      - SHARED_MALWARE_DIR=/mnt/voodoo_samples
    depends_on:
      - db
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/screenshots:/app/screenshots
      - ./backend/reports:/app/reports
      - /mnt/voodoo_samples:/mnt/voodoo_samples
      - detox_vsix_data:/vsix_archive
    restart: unless-stopped

  # ChromaDB moved to AI Server (192.168.50.98) - see deploy-ai/
  #  chromadb:
  #    image: chromadb/chroma:latest
  #    ports:
  #      - "8002:8000"
  #    volumes:
  #      - ./chroma_data:/chroma/chroma
  #    restart: unless-stopped

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=voodoobox
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=voodoobox_telemetry
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    restart: always

  ghidra:
    build: ./ghidra
    ports:
      - "8005:8000"
    volumes:
      - ./ghidra/projects:/data/projects
      - ./backend/uploads:/data/binaries
      - ./ghidra/scripts:/app/scripts
    environment:
      - HOST_IP=${HOST_IP}
    restart: unless-stopped

  mcp-server:
    build: ./mcp-server
    environment:
      - BACKEND_URL=http://hyper-bridge:8080
      - GHIDRA_API=http://ghidra:8000
      - OLLAMA_HOST=http://192.168.50.98:11434
      - CHROMADB_URL=http://192.168.50.98:8001
      - UVICORN_HOST=0.0.0.0
      - UVICORN_PORT=8001
    ports:
      - "8001:8001"
    depends_on:
      - hyper-bridge
      - ghidra
    restart: unless-stopped

  #  mock-agent:
  #    build: ./agent-mock
  #    environment:
  #      - AGENT_SERVER_ADDR=hyper-bridge:9001
  #    depends_on:
  #      - hyper-bridge
  #    restart: always

  detox-bouncer:
    build: ./detox-bouncer
    ports:
      - "8006:8000"
    environment:
      - DATABASE_URL=postgres://voodoobox:${POSTGRES_PASSWORD}@db:5432/voodoobox_telemetry
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - LLAMA_CPP_URL=${LLAMA_CPP_URL}
    depends_on:
      - db
    volumes:
      - detox_vsix_data:/app/data/vsix_archive
    restart: unless-stopped

volumes:
  postgres_data:
  detox_vsix_data:
